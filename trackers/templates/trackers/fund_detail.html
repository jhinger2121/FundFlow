{% extends 'base.html' %}
{% block title %}Fund Detail - {{ fund.name }}{% endblock title %}
{% block content %}

<div class="container mt-5">
    

    <div class="container py-4">
        <!-- Fund Overview -->
        <div class="bg-white p-4 rounded shadow-sm mb-4 border">
            <!-- Fund Name -->
            <div class="row">
                <div class="col-12 text-center mb-3">
                    <h1 class="display-4">{{ fund.name }}</h1>
                    {% if fund.description %}
                    <p class="text-muted">{{ fund.description }}</p>
                    {% endif %}
                </div>
            </div>
    
            <!-- Profit Cards -->
            <div class="row g-3">
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="bg-light p-3 rounded">
                        <p class="text-muted small mb-1">Weekly Profit</p>
                        <p class="fw-bold fs-5 mb-0">${{ fund.get_current_week_summary.weekly_profit }}</p>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="bg-light p-3 rounded">
                        <p class="text-muted small mb-1">Monthly Profit</p>
                        <p class="fw-bold fs-5 mb-0">${{ fund.get_current_month_summary.monthly_profit }}</p>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="bg-light p-3 rounded">
                        <p class="text-muted small mb-1">Annual Profit</p>
                        <p class="fw-bold fs-5 mb-0">${{ fund.get_current_year_summary.annually_profit }}</p>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="bg-light p-3 rounded">
                        <p class="text-muted small mb-1">Total Profit</p>
                        <p class="fw-bold fs-5 mb-0">${{ fund.total_profit }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container mt-4">
        <h2 class="mb-3">{{ fund.name }} - {% if show_all %}All Trades{% else %}Active Trades{% endif %}</h2>
    
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div></div>
            <a href="?{% if show_all %}{% else %}all=true{% endif %}" class="btn btn-outline-primary btn-sm">
                {% if show_all %}Show Only Active Trades{% else %}Show All Trades{% endif %}
            </a>
        </div>
    
        <table class="table table-striped table-hover shadow-sm">
            <thead class="table-light">
                <tr>
                    <th>Dates<br><small>Trade → Expiry</small></th>
                    <th>Ticker</th>
                    <th>Contracts</th>
                    <th>Strike / Trade Price</th>
                    <th>At Trade<br><small>Option Price & %OTM</small></th>
                    <th>Now<br><small>Live Price & %OTM</small></th>
                    <th>Type</th>
                    <th>Breakeven Price</th>
                    <th>P/L</th>
                </tr>
            </thead>
            <tbody>
                {% for trade in trades %}
                <tr>
                    <!-- Dates -->
                    <td>
                        {{ trade.date|date:"Y-m-d" }} → {{ trade.option.expiration_date|date:"Y-m-d" }}<br>
                        <small class="text-muted">
                            Traded {{ trade.date|timesince }} ago<br>
                            {% if trade.option.expiration_date >= today %}
                                Exp in {{ trade.option.expiration_date|timeuntil }}
                            {% endif %}
                        </small>
                    </td>

                    <!-- Ticker -->
                    <td>{{ trade.option.ticker }}</td>

                    <!-- Quantity -->
                    <td>{{ trade.quantity }}</td>

                    <!-- Strike / Trade Price -->
                    <td>
                        <strong>Strike:</strong> ${{ trade.option.strike_price|floatformat:2 }}<br>
                        <strong>You Paid:</strong> ${{ trade.price|floatformat:2 }}<br>
                        <small class="text-muted">
                            {% with diff=trade.option.strike_price|floatformat:2|add:"-{{ trade.price }}" %}
                                ({{ diff|floatformat:2 }} away)
                            {% endwith %}
                        </small>
                    </td>

                    <!-- At Trade -->
                    <td>
                        <strong>Option:</strong> ${{ trade.option.price|floatformat:2 }}<br>
                        <strong>% OTM:</strong>
                        {% if trade.option.percent_out_of_money_at_snapshot is not None %}
                            {{ trade.option.percent_out_of_money_at_snapshot|floatformat:2 }}%
                        {% else %}
                            <span class="text-muted">–</span>
                        {% endif %}
                    </td>

                    <!-- Now -->
                    <td>
                        {% if trade.option.underlying_asset.live_price %}
                            <strong>Live:</strong> ${{ trade.option.underlying_asset.live_price|floatformat:2 }}<br>
                            <strong>% OTM:</strong>
                            <span class="{% if trade.option.percent_out_of_money_now > 0 %}text-danger{% else %}text-success{% endif %}">
                                {{ trade.option.percent_out_of_money_now|floatformat:2 }}%
                            </span><br>
                            <small class="text-muted">
                                {{ trade.option.underlying_asset.live_price_updated_at|timesince }} ago
                            </small>
                        {% else %}
                            <span class="text-muted">–</span>
                        {% endif %}
                    </td>

                    <!-- Type -->
                    <td>
                        {{ trade.option.get_type_display }}<br>
                        {% if trade.get_trade_type_display == "Buy" %}
                            <span class="badge bg-success">Buy</span>
                        {% else %}
                            <span class="badge bg-danger">Sell</span>
                        {% endif %}
                    </td>
                    <td>{{ trade.option.breakeven_price|floatformat:2 }}</td>
                    <!-- Profit/Loss -->
                    <td class="{% if trade.total_price < 0 %}text-danger{% else %}text-success{% endif %}">
                        ${{ trade.total_price|floatformat:2 }}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center">No trades found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>
    
    
</div>

{% endblock %}




<!-- Options Section -->
<div class="row">
    <div class="col-12">
        <h2 class="mb-3">Options</h2>
        {% if fund.options.all %}
            <div class="accordion" id="optionsAccordion">
                {% for option in fund.options.all %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading{{ option.id }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ option.id }}" aria-expanded="false" aria-controls="collapse{{ option.id }}">
                                {{ option.ticker }} - {{ option.get_type_display }} @ ${{ option.strike_price }}
                            </button>
                        </h2>
                        <div id="collapse{{ option.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ option.id }}" data-bs-parent="#optionsAccordion">
                            <div class="accordion-body">
                                <p><strong>Underlying Asset:</strong> {{ option.underlying_asset.name }}</p>
                                <p><strong>Expiration Date:</strong> {{ option.expiration_date|date:"Y-m-d" }}</p>
                                <p><strong>Positions:</strong></p>
                                <ul>
                                    {% for position in option.positions.all %}
                                        <li>
                                            <strong>Created:</strong> {{ position.date|date:"Y-m-d" }} - 
                                            <strong>Quantity:</strong> {{ position.remaining_quantity }} - 
                                            <strong>Price:</strong> ${{ position.average_price }}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted">No options available for this fund.</p>
        {% endif %}
    </div>
</div>


<div class="container mt-5">
    <h1 class="mb-4">Trades for {{ fund.name }}</h1>
    <p>{{ fund.description }}</p>
    
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Option</th>
                <th>Type</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Total Price</th>
                <th>Date</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for option in fund.options.all %}
                {% for trade in option.trades.all %}
                <tr>
                    <td>{{ trade.option.ticker }}</td>
                    <td>{{ trade.get_trade_type_display }}</td>
                    <td>{{ trade.quantity }}</td>
                    <td>${{ trade.price }}</td>
                    <td>${{ trade.total_price }}</td>
                    <td>{{ trade.date }}</td>
                    <td>{% if trade.active %}Active{% else %}Inactive{% endif %}</td>
                </tr>
                {% endfor %}
            {% empty %}
            <tr>
                <td colspan="7" class="text-center">No trades available.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>